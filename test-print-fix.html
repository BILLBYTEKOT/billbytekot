<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Print Fix Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 600px;
            margin: 50px auto;
            padding: 20px;
        }
        .test-section {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
        }
        button {
            background: #7c3aed;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            margin: 10px;
            font-size: 16px;
        }
        button:hover {
            background: #6d28d9;
        }
        .success {
            color: #22c55e;
            font-weight: bold;
        }
        .error {
            color: #ef4444;
            font-weight: bold;
        }
        .info {
            color: #3b82f6;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <h1>üñ®Ô∏è Print Fix Test</h1>
    <p>This test verifies that the print function no longer opens unwanted save dialogs.</p>

    <div class="test-section">
        <h3>Test 1: Silent Print (Fixed)</h3>
        <p>This should print directly without opening a save dialog:</p>
        <button onclick="testSilentPrint()">Test Silent Print</button>
        <div id="silent-result"></div>
    </div>

    <div class="test-section">
        <h3>Test 2: Manual Print with Dialog</h3>
        <p>This should open a print dialog when you specifically want to print:</p>
        <button onclick="testManualPrint()">Test Manual Print</button>
        <div id="manual-result"></div>
    </div>

    <div class="test-section">
        <h3>Test 3: Popup Blocked Fallback</h3>
        <p>This tests the fallback when popups are blocked:</p>
        <button onclick="testPopupBlocked()">Test Popup Blocked</button>
        <div id="popup-result"></div>
    </div>

    <script>
        // Mock toast function
        const toast = {
            success: (msg) => showMessage(msg, 'success'),
            error: (msg) => showMessage(msg, 'error'),
            info: (msg) => showMessage(msg, 'info')
        };

        function showMessage(msg, type) {
            const resultDiv = document.querySelector(`#${getCurrentTest()}-result`);
            resultDiv.innerHTML = `<p class="${type}">${msg}</p>`;
        }

        let currentTest = '';
        function getCurrentTest() {
            return currentTest;
        }

        // Simplified version of the fixed printThermal function
        function printThermal(htmlContent, paperWidth = '80mm', forceDialog = false) {
            const showDialog = forceDialog || false;
            
            if (showDialog) {
                // Show print dialog in popup window
                const printWindow = window.open('', '_blank', 'width=400,height=600');
                if (!printWindow) {
                    toast.error('Popup blocked! Please allow popups for printing.');
                    return false;
                }
                
                const printContent = `<!DOCTYPE html><html><head><meta charset="UTF-8"><title>Print Receipt</title><style>body{font-family:monospace;padding:20px;}</style></head><body><div class="receipt">${htmlContent}</div><script>window.onload=function(){setTimeout(function(){window.print();setTimeout(function(){window.close();},300);},100);};</script></body></html>`;
                
                printWindow.document.write(printContent);
                printWindow.document.close();
                toast.success('Print dialog opened!');
                return true;
            } else {
                // Silent print without dialog - use direct window.print() instead of iframe
                try {
                    // Create a temporary print window that auto-closes
                    const printWindow = window.open('', '_blank', 'width=1,height=1,left=-1000,top=-1000');
                    if (!printWindow) {
                        // Fallback: show toast message instead of opening save dialog
                        toast.info('Receipt ready! Use Ctrl+P to print or click Print button.');
                        return false;
                    }
                    
                    const printContent = `<!DOCTYPE html><html><head><meta charset="UTF-8"><title>Receipt</title><style>body{font-family:monospace;padding:20px;}</style></head><body><div class="receipt">${htmlContent}</div></body></html>`;
                    
                    printWindow.document.write(printContent);
                    printWindow.document.close();
                    
                    // Wait for content to load, then print and close immediately
                    printWindow.onload = () => {
                        setTimeout(() => {
                            try {
                                printWindow.focus();
                                printWindow.print();
                                
                                // Close the window immediately after print command
                                setTimeout(() => {
                                    printWindow.close();
                                }, 100);
                                
                                toast.success('Receipt sent to printer!');
                            } catch (e) {
                                console.error('Print failed:', e);
                                printWindow.close();
                                toast.info('Receipt ready! Use Ctrl+P to print.');
                            }
                        }, 200);
                    };
                    
                    // Fallback cleanup
                    setTimeout(() => {
                        if (printWindow && !printWindow.closed) {
                            printWindow.close();
                        }
                    }, 3000);
                    
                    return true;
                } catch (e) {
                    console.error('Print window creation failed:', e);
                    toast.info('Receipt ready! Use Ctrl+P to print or click Print button.');
                    return false;
                }
            }
        }

        function testSilentPrint() {
            currentTest = 'silent';
            const receiptHTML = `
                <h2>TEST RECEIPT</h2>
                <p>Restaurant Name: Test Restaurant</p>
                <p>Bill No: 12345</p>
                <p>Date: ${new Date().toLocaleDateString()}</p>
                <hr>
                <p>1x Test Item - ‚Çπ100.00</p>
                <hr>
                <p><strong>Total: ‚Çπ100.00</strong></p>
                <p>Thank you for testing!</p>
            `;
            
            printThermal(receiptHTML, '80mm', false); // Silent print
        }

        function testManualPrint() {
            currentTest = 'manual';
            const receiptHTML = `
                <h2>MANUAL PRINT TEST</h2>
                <p>This should open a print dialog</p>
                <p>Date: ${new Date().toLocaleDateString()}</p>
                <p>Test successful if you see print dialog!</p>
            `;
            
            printThermal(receiptHTML, '80mm', true); // Force dialog
        }

        function testPopupBlocked() {
            currentTest = 'popup';
            
            // Simulate popup blocked scenario
            const originalOpen = window.open;
            window.open = () => null; // Simulate blocked popup
            
            const receiptHTML = `<h2>POPUP BLOCKED TEST</h2><p>This should show fallback message</p>`;
            
            printThermal(receiptHTML, '80mm', false);
            
            // Restore original function
            setTimeout(() => {
                window.open = originalOpen;
            }, 1000);
        }
    </script>
</body>
</html>