name: Daily Maintenance

on:
  schedule:
    # Run daily at 6 AM IST (12:30 AM UTC)
    - cron: '30 0 * * *'
  workflow_dispatch:

jobs:
  daily-tasks:
    runs-on: ubuntu-latest
    
    steps:
      - name: Database Health Check
        run: |
          echo "ðŸ—„ï¸ Checking database connectivity..."
          response=$(curl -s -o /dev/null -w "%{http_code}" "https://restro-ai.onrender.com/health" --max-time 60)
          if [ "$response" = "200" ]; then
            echo "âœ… Database connection healthy"
          else
            echo "âš ï¸ Database may need attention (status: $response)"
          fi

      - name: Generate Daily Report
        run: |
          echo "ðŸ“Š Daily Report - $(date '+%Y-%m-%d')"
          echo "=================================="
          echo ""
          echo "ðŸŒ Frontend Status:"
          curl -s -o /dev/null -w "  Status: %{http_code}\n  Time: %{time_total}s\n" "https://billbytekot.in" --max-time 30
          echo ""
          echo "ðŸ”§ Backend Status:"
          curl -s -o /dev/null -w "  Status: %{http_code}\n  Time: %{time_total}s\n" "https://restro-ai.onrender.com/health" --max-time 60
          echo ""
          echo "ðŸ“± AssetLinks Status:"
          response=$(curl -s "https://billbytekot.in/.well-known/assetlinks.json" --max-time 15)
          if echo "$response" | grep -q "sha256_cert_fingerprints"; then
            echo "  âœ… Configured correctly"
          else
            echo "  âš ï¸ May need attention"
          fi

      - name: SEO Ping
        run: |
          echo "ðŸ” Submitting sitemaps to search engines..."
          
          # Google
          curl -s "https://www.google.com/ping?sitemap=https://billbytekot.in/sitemap.xml" > /dev/null 2>&1
          echo "âœ… Google sitemap submitted"
          
          # Bing
          curl -s "https://www.bing.com/ping?sitemap=https://billbytekot.in/sitemap.xml" > /dev/null 2>&1
          echo "âœ… Bing sitemap submitted"
          
          # IndexNow (Bing, Yandex, etc.)
          curl -s "https://www.bing.com/indexnow?url=https://billbytekot.in&key=billbytekot" > /dev/null 2>&1
          echo "âœ… IndexNow pinged"

      - name: Warm Up Cache
        run: |
          echo "ðŸ”¥ Warming up application cache..."
          
          # Hit main endpoints to warm cache
          ENDPOINTS=(
            "https://restro-ai.onrender.com/"
            "https://restro-ai.onrender.com/health"
            "https://billbytekot.in"
          )
          
          for endpoint in "${ENDPOINTS[@]}"; do
            curl -s -o /dev/null "$endpoint" --max-time 30 || true
            sleep 1
          done
          
          echo "âœ… Cache warmed up"
