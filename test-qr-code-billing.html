<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QR Code Test - Billing</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 8px; }
        .qr-code { border: 2px solid #000; padding: 10px; display: inline-block; margin: 10px; }
        .success { background-color: #d4edda; border-color: #c3e6cb; }
        .error { background-color: #f8d7da; border-color: #f5c6cb; }
        .info { background-color: #d1ecf1; border-color: #bee5eb; }
    </style>
</head>
<body>
    <h1>QR Code Generation Test - Billing Page</h1>
    
    <div class="test-section info">
        <h3>Test Scenario: Partial Payment with QR Code</h3>
        <p>Testing QR code generation for partial payment scenario</p>
        <ul>
            <li>Bill Total: ₹500.00</li>
            <li>Amount Received: ₹250.00</li>
            <li>Balance Due: ₹250.00</li>
            <li>QR Code Enabled: true</li>
        </ul>
    </div>

    <div class="test-section" id="qr-test-result">
        <h3>QR Code Generation Test</h3>
        <div id="qr-output"></div>
    </div>

    <div class="test-section" id="print-settings-test">
        <h3>Print Settings Test</h3>
        <div id="settings-output"></div>
    </div>

    <script>
        // Simulate the print settings function
        function getPrintSettings() {
            try {
                const user = JSON.parse(localStorage.getItem('user') || '{}');
                const s = user.business_settings?.print_customization || {};
                return {
                    qr_code_enabled: s.qr_code_enabled ?? true,
                    paper_width: s.paper_width || '80mm',
                    show_logo: s.show_logo ?? true,
                    show_address: s.show_address ?? true,
                    show_phone: s.show_phone ?? true,
                    show_gstin: s.show_gstin ?? true,
                    show_fssai: s.show_fssai ?? true,
                    show_tagline: s.show_tagline ?? true,
                    show_customer_name: s.show_customer_name ?? true,
                    show_waiter_name: s.show_waiter_name ?? true,
                    show_table_number: s.show_table_number ?? true,
                    show_order_time: s.show_order_time ?? true,
                    show_item_notes: s.show_item_notes ?? true,
                    print_copies: Math.max(1, Math.min(5, parseInt(s.print_copies) || 1)),
                    kot_show_time: s.kot_show_time ?? true,
                    kot_highlight_notes: s.kot_highlight_notes ?? true,
                };
            } catch (e) {
                return { 
                    qr_code_enabled: true, 
                    paper_width: '80mm', 
                    show_logo: true, 
                    show_address: true, 
                    show_phone: true, 
                    show_gstin: true, 
                    show_fssai: true, 
                    show_tagline: true, 
                    show_customer_name: true, 
                    show_waiter_name: true, 
                    show_table_number: true, 
                    show_order_time: true, 
                    show_item_notes: true, 
                    print_copies: 1, 
                    kot_show_time: true, 
                    kot_highlight_notes: true 
                };
            }
        }

        // Simulate business settings
        function getBusinessSettings() {
            return {
                restaurant_name: 'Test Restaurant',
                phone: '9876543210',
                upi_id: '9876543210@paytm',
                address: 'Test Address, City',
                footer_message: 'Thank you! Visit Again...'
            };
        }

        // Generate payment URL for QR code
        function generatePaymentUrl(order, businessSettings) {
            const billNo = order.id.toString().padStart(5, '0');
            const amount = order.balance_amount || order.total || 0;
            const restaurantName = businessSettings?.restaurant_name || 'Restaurant';
            
            let upiId = businessSettings?.upi_id;
            if (!upiId && businessSettings?.phone) {
                upiId = `${businessSettings.phone}@paytm`;
            }
            if (!upiId) {
                upiId = 'payment@restaurant.com';
            }
            
            const paymentUrl = `upi://pay?pa=${encodeURIComponent(upiId)}&pn=${encodeURIComponent(restaurantName)}&am=${amount}&cu=INR&tn=${encodeURIComponent(`Bill ${billNo} - ${restaurantName}`)}`;
            
            return paymentUrl;
        }

        // Generate QR code data URL
        function generateQRCodeDataUrl(text, size = 120) {
            try {
                const qrUrl = `https://chart.googleapis.com/chart?chs=${size}x${size}&cht=qr&chl=${encodeURIComponent(text)}&choe=UTF-8&chld=M|0`;
                return qrUrl;
            } catch (error) {
                console.error('QR code generation failed:', error);
                return null;
            }
        }

        // Test QR code generation
        function testQRCodeGeneration() {
            const settings = getPrintSettings();
            const businessSettings = getBusinessSettings();
            
            // Test order with partial payment
            const testOrder = {
                id: 12345,
                total: 500.00,
                payment_received: 250.00,
                balance_amount: 250.00,
                is_credit: true,
                customer_name: 'Test Customer',
                customer_phone: '9876543210',
                items: [
                    { name: 'Test Item 1', quantity: 2, price: 150 },
                    { name: 'Test Item 2', quantity: 1, price: 200 }
                ]
            };

            const qrTestDiv = document.getElementById('qr-test-result');
            const qrOutput = document.getElementById('qr-output');
            
            console.log('Testing QR code generation...');
            console.log('Settings:', settings);
            console.log('Order:', testOrder);
            console.log('Business Settings:', businessSettings);

            // Check if QR code should be generated
            const isUnpaid = testOrder.is_credit || testOrder.balance_amount > 0;
            const shouldShowQR = settings.qr_code_enabled && isUnpaid;

            qrOutput.innerHTML = `
                <p><strong>QR Code Enabled:</strong> ${settings.qr_code_enabled}</p>
                <p><strong>Is Unpaid:</strong> ${isUnpaid}</p>
                <p><strong>Should Show QR:</strong> ${shouldShowQR}</p>
                <p><strong>Balance Amount:</strong> ₹${testOrder.balance_amount}</p>
            `;

            if (shouldShowQR) {
                const paymentUrl = generatePaymentUrl(testOrder, businessSettings);
                const qrCodeDataUrl = generateQRCodeDataUrl(paymentUrl);
                
                qrOutput.innerHTML += `
                    <p><strong>Payment URL:</strong> <code style="word-break: break-all;">${paymentUrl}</code></p>
                    <p><strong>QR Code URL:</strong> <code style="word-break: break-all;">${qrCodeDataUrl}</code></p>
                    <div class="qr-code">
                        <img src="${qrCodeDataUrl}" alt="Payment QR Code" style="width:120px;height:120px;" 
                             onload="this.parentElement.style.backgroundColor='#d4edda'" 
                             onerror="this.parentElement.style.backgroundColor='#f8d7da'; this.alt='QR Code Failed to Load'"/>
                    </div>
                `;
                qrTestDiv.className = 'test-section success';
            } else {
                qrOutput.innerHTML += '<p><strong>QR Code will NOT be shown</strong></p>';
                qrTestDiv.className = 'test-section error';
            }
        }

        // Test print settings
        function testPrintSettings() {
            const settings = getPrintSettings();
            const settingsOutput = document.getElementById('settings-output');
            const settingsDiv = document.getElementById('print-settings-test');
            
            settingsOutput.innerHTML = `
                <pre>${JSON.stringify(settings, null, 2)}</pre>
                <p><strong>QR Code Enabled:</strong> ${settings.qr_code_enabled ? '✅ YES' : '❌ NO'}</p>
            `;
            
            if (settings.qr_code_enabled) {
                settingsDiv.className = 'test-section success';
            } else {
                settingsDiv.className = 'test-section error';
            }
        }

        // Run tests
        document.addEventListener('DOMContentLoaded', function() {
            testPrintSettings();
            testQRCodeGeneration();
        });
    </script>
</body>
</html>